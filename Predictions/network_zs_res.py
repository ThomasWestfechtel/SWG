import numpy as np
import clip
import torch
import torch.nn as nn
from torch.nn import functional as F

def get_names(dset):
    if(dset=='office-home'):
        classes = [
            'alarm clock',
            'backpack',
            'batteries',
            'bed',
            'bike',
            'bottle',
            'bucket',
            'calculator',
            'calendar',
            'candles',
            'chair',
            'clipboards',
            'computer',
            'couch',
            'curtains',
            'desk lamp',
            'drill',
            'eraser',
            'exit sign',
            'fan',
            'file cabinet',
            'flipflops',
            'flowers',
            'folder',
            'fork',
            'glasses',
            'hammer',
            'helmet',
            'kettle',
            'keyboard',
            'knives',
            'lamp shade',
            'laptop',
            'marker',
            'monitor',
            'mop',
            'mouse',
            'mug',
            'notebook',
            'oven',
            'pan',
            'paper clip',
            'pen',
            'pencil',
            'postit notes',
            'printer',
            'push pin',
            'radio',
            'refrigerator',
            'ruler',
            'scissors',
            'screwdriver',
            'shelf',
            'sink',
            'sneakers',
            'soda',
            'speaker',
            'spoon',
            'table',
            'telephone',
            'toothbrush',
            'toys',
            'trash can',
            'tv',
            'webcam',
        ]
    elif(dset=='office'):
        classes = [
            'back pack',
            'bike',
            'bike helmet',
            'bookcase',
            'bottle',
            'calculator',
            'desk chair',
            'desk lamp',
            'desktop computer',
            'file cabinet',
            'headphones',
            'keyboard',
            'laptop computer',
            'desk tray',
            'mobile phone',
            'monitor',
            'mouse',
            'mug',
            'paper notebook',
            'pen',
            'cord phone',
            'printer',
            'projector',
            'hole puncher',
            'ring binder',
            'ruler',
            'scissors',
            'music speaker',
            'stapler',
            'tape dispenser',
            'trash can',
        ]
    elif(dset=='visda'):
        classes = [
            'aeroplane',
            'bicycle',
            'bus',
            'car',
            'horse',
            'knife',
            'motorcycle',
            'person',
            'plant',
            'skateboard',
            'train',
            'truck',
        ]
    elif(dset=='domain-net'):
        classes = [
            'aircraft carrier',
            'airplane',
            'alarm clock',
            'ambulance',
            'angel',
            'animal migration',
            'ant',
            'anvil',
            'apple',
            'arm',
            'asparagus',
            'axe',
            'backpack',
            'banana',
            'bandage',
            'barn',
            'baseball',
            'baseball bat',
            'basket',
            'basketball',
            'bat',
            'bathtub',
            'beach',
            'bear',
            'beard',
            'bed',
            'bee',
            'belt',
            'bench',
            'bicycle',
            'binoculars',
            'bird',
            'birthday cake',
            'blackberry',
            'blueberry',
            'book',
            'boomerang',
            'bottlecap',
            'bowtie',
            'bracelet',
            'brain',
            'bread',
            'bridge',
            'broccoli',
            'broom',
            'bucket',
            'bulldozer',
            'bus',
            'bush',
            'butterfly',
            'cactus',
            'cake',
            'calculator',
            'calendar',
            'camel',
            'camera',
            'camouflage',
            'campfire',
            'candle',
            'cannon',
            'canoe',
            'car',
            'carrot',
            'castle',
            'cat',
            'ceiling fan',
            'cello',
            'cell phone',
            'chair',
            'chandelier',
            'church',
            'circle',
            'clarinet',
            'clock',
            'cloud',
            'coffee cup',
            'compass',
            'computer',
            'cookie',
            'cooler',
            'couch',
            'cow',
            'crab',
            'crayon',
            'crocodile',
            'crown',
            'cruise ship',
            'cup',
            'diamond',
            'dishwasher',
            'diving board',
            'dog',
            'dolphin',
            'donut',
            'door',
            'dragon',
            'dresser',
            'drill',
            'drums',
            'duck',
            'dumbbell',
            'ear',
            'elbow',
            'elephant',
            'envelope',
            'eraser',
            'eye',
            'eyeglasses',
            'face',
            'fan',
            'feather',
            'fence',
            'finger',
            'fire hydrant',
            'fireplace',
            'firetruck',
            'fish',
            'flamingo',
            'flashlight',
            'flip flops',
            'floor lamp',
            'flower',
            'flying saucer',
            'foot',
            'fork',
            'frog',
            'frying pan',
            'garden',
            'garden hose',
            'giraffe',
            'goatee',
            'golf club',
            'grapes',
            'grass',
            'guitar',
            'hamburger',
            'hammer',
            'hand',
            'harp',
            'hat',
            'headphones',
            'hedgehog',
            'helicopter',
            'helmet',
            'hexagon',
            'hockey puck',
            'hockey stick',
            'horse',
            'hospital',
            'hot air balloon',
            'hot dog',
            'hot tub',
            'hourglass',
            'house',
            'house plant',
            'hurricane',
            'ice cream',
            'jacket',
            'jail',
            'kangaroo',
            'key',
            'keyboard',
            'knee',
            'knife',
            'ladder',
            'lantern',
            'laptop',
            'leaf',
            'leg',
            'light bulb',
            'lighter',
            'lighthouse',
            'lightning',
            'line',
            'lion',
            'lipstick',
            'lobster',
            'lollipop',
            'mailbox',
            'map',
            'marker',
            'matches',
            'megaphone',
            'mermaid',
            'microphone',
            'microwave',
            'monkey',
            'moon',
            'mosquito',
            'motorbike',
            'mountain',
            'mouse',
            'moustache',
            'mouth',
            'mug',
            'mushroom',
            'nail',
            'necklace',
            'nose',
            'ocean',
            'octagon',
            'octopus',
            'onion',
            'oven',
            'owl',
            'paintbrush',
            'paint can',
            'palm tree',
            'panda',
            'pants',
            'paper clip',
            'parachute',
            'parrot',
            'passport',
            'peanut',
            'pear',
            'peas',
            'pencil',
            'penguin',
            'piano',
            'pickup truck',
            'picture frame',
            'pig',
            'pillow',
            'pineapple',
            'pizza',
            'pliers',
            'police car',
            'pond',
            'pool',
            'popsicle',
            'postcard',
            'potato',
            'power outlet',
            'purse',
            'rabbit',
            'raccoon',
            'radio',
            'rain',
            'rainbow',
            'rake',
            'remote control',
            'rhinoceros',
            'rifle',
            'river',
            'roller coaster',
            'rollerskates',
            'sailboat',
            'sandwich',
            'saw',
            'saxophone',
            'school bus',
            'scissors',
            'scorpion',
            'screwdriver',
            'sea turtle',
            'see saw',
            'shark',
            'sheep',
            'shoe',
            'shorts',
            'shovel',
            'sink',
            'skateboard',
            'skull',
            'skyscraper',
            'sleeping bag',
            'smiley face',
            'snail',
            'snake',
            'snorkel',
            'snowflake',
            'snowman',
            'soccer ball',
            'sock',
            'speedboat',
            'spider',
            'spoon',
            'spreadsheet',
            'square',
            'squiggle',
            'squirrel',
            'stairs',
            'star',
            'steak',
            'stereo',
            'stethoscope',
            'stitches',
            'stop sign',
            'stove',
            'strawberry',
            'streetlight',
            'string bean',
            'submarine',
            'suitcase',
            'sun',
            'swan',
            'sweater',
            'swing set',
            'sword',
            'syringe',
            'table',
            'teapot',
            'teddy-bear',
            'telephone',
            'television',
            'tennis racquet',
            'tent',
            'The Eiffel Tower',
            'The Great Wall of China',
            'The Mona Lisa',
            'tiger',
            'toaster',
            'toe',
            'toilet',
            'tooth',
            'toothbrush',
            'toothpaste',
            'tornado',
            'tractor',
            'traffic light',
            'train',
            'tree',
            'triangle',
            'trombone',
            'truck',
            'trumpet',
            't-shirt',
            'umbrella',
            'underwear',
            'van',
            'vase',
            'violin',
            'washing machine',
            'watermelon',
            'waterslide',
            'whale',
            'wheel',
            'windmill',
            'wine bottle',
            'wine glass',
            'wristwatch',
            'yoga',
            'zebra',
            'zigzag',
        ]
    return classes

def get_templates(id):
    ### 0 = Normal; 1 = CIFAR; 2 = ImageNet; 3 = ImageNetSmall ###
    if(id == 0):
        templates = [
            'a {}',
        ]
    elif(id == 1):
        # #### CIFAR ####
        templates = [
            'a photo of a {}.',
            'a blurry photo of a {}.',
            'a black and white photo of a {}.',
            'a low contrast photo of a {}.',
            'a high contrast photo of a {}.',
            'a bad photo of a {}.',
            'a good photo of a {}.',
            'a photo of a small {}.',
            'a photo of a big {}.',
            'a photo of the {}.',
            'a blurry photo of the {}.',
            'a black and white photo of the {}.',
            'a low contrast photo of the {}.',
            'a high contrast photo of the {}.',
            'a bad photo of the {}.',
            'a good photo of the {}.',
            'a photo of the small {}.',
            'a photo of the big {}.',
        ]
    elif(id == 2):
        #### ImageNet ####
        templates = [
            'a bad photo of a {}.',
            'a photo of many {}.',
            'a sculpture of a {}.',
            'a photo of the hard to see {}.',
            'a low resolution photo of the {}.',
            'a rendering of a {}.',
            'graffiti of a {}.',
            'a bad photo of the {}.',
            'a cropped photo of the {}.',
            'a tattoo of a {}.',
            'the embroidered {}.',
            'a photo of a hard to see {}.',
            'a bright photo of a {}.',
            'a photo of a clean {}.',
            'a photo of a dirty {}.',
            'a dark photo of the {}.',
            'a drawing of a {}.',
            'a photo of my {}.',
            'the plastic {}.',
            'a photo of the cool {}.',
            'a close-up photo of a {}.',
            'a black and white photo of the {}.',
            'a painting of the {}.',
            'a painting of a {}.',
            'a pixelated photo of the {}.',
            'a sculpture of the {}.',
            'a bright photo of the {}.',
            'a cropped photo of a {}.',
            'a plastic {}.',
            'a photo of the dirty {}.',
            'a jpeg corrupted photo of a {}.',
            'a blurry photo of the {}.',
            'a photo of the {}.',
            'a good photo of the {}.',
            'a rendering of the {}.',
            'a {} in a video game.',
            'a photo of one {}.',
            'a doodle of a {}.',
            'a close-up photo of the {}.',
            'a photo of a {}.',
            'the origami {}.',
            'the {} in a video game.',
            'a sketch of a {}.',
            'a doodle of the {}.',
            'a origami {}.',
            'a low resolution photo of a {}.',
            'the toy {}.',
            'a rendition of the {}.',
            'a photo of the clean {}.',
            'a photo of a large {}.',
            'a rendition of a {}.',
            'a photo of a nice {}.',
            'a photo of a weird {}.',
            'a blurry photo of a {}.',
            'a cartoon {}.',
            'art of a {}.',
            'a sketch of the {}.',
            'a embroidered {}.',
            'a pixelated photo of a {}.',
            'itap of the {}.',
            'a jpeg corrupted photo of the {}.',
            'a good photo of a {}.',
            'a plushie {}.',
            'a photo of the nice {}.',
            'a photo of the small {}.',
            'a photo of the weird {}.',
            'the cartoon {}.',
            'art of the {}.',
            'a drawing of the {}.',
            'a photo of the large {}.',
            'a black and white photo of a {}.',
            'the plushie {}.',
            'a dark photo of a {}.',
            'itap of a {}.',
            'graffiti of the {}.',
            'a toy {}.',
            'itap of my {}.',
            'a photo of a cool {}.',
            'a photo of a small {}.',
            'a tattoo of the {}.',
        ]
    elif(id == 3):
        #### ImageNetSmall ####
        templates = [
            'itap of a {}.',
            'a bad photo of the {}.',
            'a origami {}.',
            'a photo of the large {}.',
            'a {} in a video game.',
            'art of the {}.',
            'a photo of the small {}.',
        ]
    return templates

class ResNetFc(nn.Module):
  def __init__(self, class_num=1000, template_id=3, inter=1, dset='office-home'):
    super(ResNetFc, self).__init__()
    model_clip, _  = clip.load("RN50")

    classnames = get_names(dset)
    templates = get_templates(template_id)
    model_bb = model_clip.visual.type(torch.float32)
    model, preprocess = clip.load("RN50")
    self.backbone = model_bb
    self.inter=inter
    with torch.no_grad():
        zeroshot_weights = []
        for classname in classnames:
            texts = [template.format(classname) for template in templates] #format with class
            texts = clip.tokenize(texts).cuda() #tokenize
            class_embeddings = model.encode_text(texts) #embed with text encoder
            class_embeddings /= class_embeddings.norm(dim=-1, keepdim=True)
            class_embedding = class_embeddings.mean(dim=0)
            class_embedding /= class_embedding.norm()
            zeroshot_weights.append(class_embedding)
        zeroshot_weights = torch.stack(zeroshot_weights, dim=1).cuda()
    class_weights = zeroshot_weights
    class_weights = class_weights.permute(1, 0)
    # class_weights = torch.from_numpy(cw).cuda()
    class_weights = class_weights / class_weights.norm(dim=1, keepdim=True)
    self.cfy = nn.Linear(512, class_num)
    self.cfy.weight.data = class_weights.type(torch.float32)
    self.cfy.bias.data.fill_(0.00)


  def forward(self, x: torch.Tensor):
    x = self.backbone.conv1(x)  # shape = [*, width, grid, grid]
    x = self.backbone.bn1(x)  # shape = [*, width, grid, grid]
    x = self.backbone.relu1(x)  # shape = [*, width, grid, grid]
    x = self.backbone.conv2(x)  # shape = [*, width, grid, grid]
    x = self.backbone.bn2(x)  # shape = [*, width, grid, grid]
    x = self.backbone.relu2(x)  # shape = [*, width, grid, grid]
    x = self.backbone.conv3(x)  # shape = [*, width, grid, grid]
    x = self.backbone.bn3(x)  # shape = [*, width, grid, grid]
    x = self.backbone.relu3(x)  # shape = [*, width, grid, grid]
    x = self.backbone.avgpool(x)  # shape = [*, width, grid, grid]

    x = self.backbone.layer1(x)
    x = self.backbone.layer2(x)
    x = self.backbone.layer3(x)
    x = self.backbone.layer4(x)

    # print(x.shape)

    # x = self.backbone.attnpool(x)
    interpos = torch.zeros((x.shape[2], x.shape[3], x.shape[1]))
    interpos = interpos.cuda()

    x = x.reshape(x.shape[0], x.shape[1], x.shape[2] * x.shape[3]).permute(2, 0, 1)  # NCHW -> (HW)NC
    x = torch.cat([x.mean(dim=0, keepdim=True), x], dim=0)  # (HW+1)NC
    if(self.inter==1):
        temp = self.backbone.attnpool.positional_embedding[:, None, :].to(x.dtype)
        # print(temp.shape)
        c_emb = temp[0:1,:]
        temp = temp[1:,:]
        temp = temp.reshape((1,1,7,7,temp.shape[2]))
        interpos = nn.functional.interpolate(temp, size=[interpos.shape[0], interpos.shape[1], interpos.shape[2]], mode='trilinear')
        interpos = interpos.reshape(-1, 1, interpos.shape[4])
        interpos = torch.cat([c_emb, interpos], dim=0)
        x = x + interpos.detach()
    else:
        x = x + self.backbone.attnpool.positional_embedding[:, None, :].to(x.dtype)  # (HW+1)NC
    x, _ = F.multi_head_attention_forward(
        query=x, key=x, value=x,
        embed_dim_to_check=x.shape[-1],
        num_heads=self.backbone.attnpool.num_heads,
        q_proj_weight=self.backbone.attnpool.q_proj.weight,
        k_proj_weight=self.backbone.attnpool.k_proj.weight,
        v_proj_weight=self.backbone.attnpool.v_proj.weight,
        in_proj_weight=None,
        in_proj_bias=torch.cat([self.backbone.attnpool.q_proj.bias, self.backbone.attnpool.k_proj.bias, self.backbone.attnpool.v_proj.bias]),
        bias_k=None,
        bias_v=None,
        add_zero_attn=False,
        dropout_p=0.,
        out_proj_weight=self.backbone.attnpool.c_proj.weight,
        out_proj_bias=self.backbone.attnpool.c_proj.bias,
        use_separate_proj_weight=True,
        training=self.backbone.attnpool.training,
        need_weights=False
    )

    x = x[0]


    y = self.cfy(x)
    return x, y